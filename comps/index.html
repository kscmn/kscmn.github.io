<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LZD9DR8ZX5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-LZD9DR8ZX5');
    </script>

    <title>Sports Card Comps | Kato Sports Cards</title>
    
    <link rel="stylesheet" href="https://kscmn.com/style.css">

    <style>
        /* Specific styles for the Comps results display */
        #resultsArea { margin-top: 30px; display: none; }
        .avg-container { padding: 20px; background: var(--accent-light, #e7f1ff); border-radius: 8px; margin-bottom: 20px; }
        .price-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .loader { color: var(--primary); font-weight: bold; padding: 20px; }
        .error-msg { color: #dc3545; background: #fff5f5; padding: 15px; border-radius: 8px; }
    </style>
</head>
<body>

<div class="container">
    <nav class="breadcrumbs">
        <a href="https://kscmn.com">Home</a> &nbsp;/&nbsp; Comps
    </nav>

    <main class="ksc-card">
        <h1>Card Comps</h1>
        <p style="color: var(--text-muted); margin-bottom: 25px;">Find recent eBay sold prices instantly.</p>
        
        <form id="compsForm">
            <input type="text" id="cardQuery" class="search-input" placeholder="e.g. 2024 Topps Series 1 Elly De La Cruz" required>
            <button type="submit" class="ksc-button">Get Sold Comps</button>
        </form>

        <div id="status" class="loader" style="display:none;">Searching eBay Market Data...</div>

        <div id="resultsArea">
            <div class="avg-container">
                <div style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted);">Average Sold Price</div>
                <div id="avgPrice" style="color: var(--primary); font-size: 2.5rem; font-weight: 800;">$0.00</div>
                <div id="saleCount" style="font-size: 0.85rem; color: var(--text-muted);">Based on last 0 sales</div>
            </div>

            <div id="soldList"></div>
            
            <div style="margin-top: 20px;">
                <a id="ebayLink" href="#" target="_blank" class="secondary-link" style="width: 100%;">View All Results on eBay</a>
            </div>
        </div>
    </main>
</div>

<footer>
    <div class="footer-copyright">Â© 2026 Kato Sports Cards. All Rights Reserved.</div>
    <div class="location-text">Mankato, Minnesota</div>
</footer>

<script>
document.getElementById('compsForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const query = document.getElementById('cardQuery').value;
    const status = document.getElementById('status');
    const resultsArea = document.getElementById('resultsArea');
    const soldList = document.getElementById('soldList');
    const avgDisplay = document.getElementById('avgPrice');
    const countDisplay = document.getElementById('saleCount');
    const ebayLink = document.getElementById('ebayLink');

    // 1. Setup UI for loading
    status.style.display = 'block';
    resultsArea.style.display = 'none';
    soldList.innerHTML = "";

    // 2. Replace with your actual Cloudflare Worker URL
    const workerUrl = `https://ebay-comps-api.katosportscards.workers.dev/?q=${encodeURIComponent(query)}`;
    
    // Set the "View on eBay" link immediately
    ebayLink.href = `https://www.ebay.com/sch/i.html?_nkw=${encodeURIComponent(query)}&LH_Sold=1&LH_Complete=1&_sop=13`;

    try {
        const response = await fetch(workerUrl);
        if (!response.ok) throw new Error("Worker Error");
        
        const html = await response.text();
        const doc = new DOMParser().parseFromString(html, 'text/html');
        
        // eBay uses '.s-item__price' for the price display
        const priceElements = doc.querySelectorAll('.s-item__price');
        
        let prices = [];
        priceElements.forEach((el, i) => {
            // Index 0 is often a "suggested" or "results matching" header in eBay's HTML
            if (i > 0) { 
                const rawPrice = el.innerText.replace(/[^0-9.]/g, '');
                const cleanPrice = parseFloat(rawPrice);
                if (!isNaN(cleanPrice)) {
                    prices.push(cleanPrice);
                }
            }
        });

        if (prices.length > 0) {
            // Calculate Average (Top 10 sales)
            const topSales = prices.slice(0, 10);
            const sum = topSales.reduce((a, b) => a + b, 0);
            const avg = sum / topSales.length;

            // Update UI
            avgDisplay.innerText = `$${avg.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            countDisplay.innerText = `Based on last ${topSales.length} sales`;
            
            topSales.forEach((p, i) => {
                soldList.innerHTML += `
                    <div class="price-item">
                        <span>Recent Sale ${i + 1}</span>
                        <strong>$${p.toFixed(2)}</strong>
                    </div>`;
            });

            status.style.display = 'none';
            resultsArea.style.display = 'block';
        } else {
            status.innerHTML = "<div class='error-msg'>No sold listings found. Try a broader search.</div>";
        }

    } catch (err) {
        status.innerHTML = "<div class='error-msg'>Connection Error. Ensure your Worker URL is correct and CORS is enabled.</div>";
        console.error(err);
    }
});
</script>

</body>
</html>
